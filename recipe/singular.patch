From 4ffce68a7f90dd47ba8fe4858e0c407b17d3c01e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Julian=20R=C3=BCth?= <julian.rueth@fsfe.org>
Date: Sat, 5 Feb 2022 10:40:45 -0500
Subject: [PATCH] Do not run singular checks when cross compiling

---
 build/pkgs/singular/spkg-configure.m4 | 43 +--------------------------
 1 file changed, 1 insertion(+), 42 deletions(-)

diff --git a/build/pkgs/singular/spkg-configure.m4 b/build/pkgs/singular/spkg-configure.m4
index 254fff9034d..5b1b93aa29e 100644
--- a/build/pkgs/singular/spkg-configure.m4
+++ b/build/pkgs/singular/spkg-configure.m4
@@ -2,48 +2,7 @@ SAGE_SPKG_CONFIGURE([singular], [
   SAGE_SPKG_DEPCHECK([gmp ntl flint readline mpfr cddlib], [
 
     AC_PATH_PROG([SINGULAR_BIN], [Singular])
-    AS_IF([test -z "${SINGULAR_BIN}"], [sage_spkg_install_singular=yes], [
-      dnl Use pkg-config to ensure that Singular is new enough.
-      PKG_CHECK_MODULES([SINGULAR], [Singular >= 4.1.1], [
-        dnl We have Singular. Now determine the shared library path on
-        dnl platforms on which sage.libs.singular needs to reload the library with RTLD_GLOBAL.
-        AS_CASE([$host_os],
-          [cygwin*], [dnl Nothing to do
-                     ],
-                     [dnl Use pkg-config to get singular's libdir while we're at it. As a
-                      dnl moral compromise for using pkg-config, this ultimately allows us
-                      dnl to pass an absolute path to dlopen(), which is the only approach
-                      dnl that POSIX guarantees will work.
-                      PKG_CHECK_VAR([SINGULAR_LIB_DIR], [Singular], [libdir])
-                      dnl The acl_shlibext variable is set in the top-level configure.ac.
-                      LIBSINGULAR_PATH="${SINGULAR_LIB_DIR}/libSingular.${acl_shlibext}"
-
-                      AC_MSG_CHECKING([if we can dlopen($LIBSINGULAR_PATH)])
-                      ORIG_LIBS="${LIBS}"
-                      LIBS="${LIBS} -ldl"
-                      AC_LANG_PUSH(C)
-
-                      dnl if we can dlopen() it, substitute the name for sage_conf;
-                      dnl otherwise, fall back to using the SPKG.
-                      AC_RUN_IFELSE(
-                        [AC_LANG_PROGRAM(
-                          [[#include <dlfcn.h>]],
-                          [[void* h = dlopen("${LIBSINGULAR_PATH}", RTLD_LAZY | RTLD_GLOBAL);
-                            if (h == 0) { return 1; } else { return dlclose(h); }]]
-                        )], [
-                          AC_MSG_RESULT(yes)
-                        ], [
-                          AC_MSG_RESULT(no)
-                          sage_spkg_install_singular=yes
-                        ])
-
-                      AC_LANG_POP()
-                      LIBS="${ORIG_LIBS}"
-                     ]
-      )], [dnl pkg-config version check failed
-        sage_spkg_install_singular=yes
-      ])
-    ])
+    sage_spkg_install_singular=no
   ])
 ],[],[],[
   dnl Post-check phase
-- 
2.35.1

